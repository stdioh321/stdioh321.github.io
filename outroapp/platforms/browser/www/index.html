<html ng-app='ang'>
<head>
	<title>Index HTML</title>
		<meta charset="utf-8" />
		<script type="text/javascript" src="node_modules/jquery/dist/jquery.js"></script>
		<script type="text/javascript" src="cordova.js"></script>
		<!-- 
		<script type="text/javascript" src="node_modules/bootstrap/dist/js/bootstrap.js"></script>
		 -->
		<script type="text/javascript" src="node_modules/angular/angular.js"></script>
		
		<script type="text/javascript" src='node_modules/angular-messages/angular-messages.js'></script>
		
		<link rel="stylesheet" type="text/css" href="node_modules/bootstrap/dist/css/bootstrap.css" >
		
		

		<style type="text/css">
			.table thead{
					font-weight: bolder;
			}
			.container h2{
				text-align: center;
			}
			form > *{
				margin-bottom: 1.5em;
			}
			p{
				word-break: break-all;
			}
		</style>
<!-- 
		<script type="text/javascript" src="cordova.js"></script>
-->
		<script type="text/javascript">
			angular.module('ang', ['ngMessages']);

			angular.module('ang').factory('criaHash', function(){
				var _criaHash = function(){
					return "abcd123456";
				};
				return {
					criaHash: _criaHash

				}
			});
			angular.module('ang').filter('showString', function(){
				return function(input){
						return input;
				}

			});
			angular.module('ang').directive('uiUtil', function(){
				return {
						require: 'ngModel',
						link: function(scope, elem, attr, ctrl){
								var _att = attr.uiUtil.replace(/\s/ig, "");

								var _formatCpf = function(cpf){
										cpf = cpf || "";
										cpf = cpf.replace(/[^0-9]/ig, "");

										if(cpf.length >= 10){
											cpf = cpf.substring(0,9) + "-" + cpf.substring(9,11);
										}
										if(cpf.length > 6){
											cpf = cpf.substring(0,6) + "." + cpf.substring(6);
										}

										if(cpf.length > 3){
											cpf = cpf.substring(0,3) + "." + cpf.substring(3);
										}


										return cpf;
								};

								var _formatNome = function(nome){
										nome = nome || "";
										console.log('\''+nome+'\'');
										nome= nome.replace(/[0-9]/ig, "");
										
										nome= nome.replace(/\s{2,}/ig, " ");
										
										return nome;


								};
								var _formatTelefone = function(telefone){
										telefone = telefone || "";
										telefone = telefone.replace(/[^0-9]/ig, "");
										if(telefone.length == 8){
												telefone = telefone.substring(0,4) + '-' + telefone.substring(4);
										}else if(telefone.length > 8){
												telefone = telefone.substring(0,5) + '-' + telefone.substring(5,9);
										}
										return telefone;
								};
								if(attr.uiUtil.replace(/\s/ig, "") == "telefone")
								{	
										$(elem).bind('keyup', function(){
												ctrl.$setViewValue(_formatTelefone(ctrl.$viewValue));
												ctrl.$render();
		
										});

										ctrl.$parsers.push(function(value){
												value = value.replace(/\-/ig, "");
												return value;
										});
								}else if(attr.uiUtil.replace(/\s/ig, "") == "nome"){
										$(elem).bind('change', function(){
												
												ctrl.$setViewValue(_formatNome(ctrl.$viewValue));
												ctrl.$render();
										});
								}else if(attr.uiUtil.replace(/\s/ig, "") == "cpf"){
										$(elem).bind('keyup', function(){
												
												ctrl.$setViewValue(_formatCpf(ctrl.$viewValue));
												ctrl.$render();
										});
										ctrl.$parsers.push(function(value){
												return value.replace(/[^0-9]/ig, "");
										});
								}
						}
				}
			});

			angular.module('ang').controller('angCtrl', function($scope, criaHash, $http){
					$scope.msg = "Ola Angular";

					$scope.contatos = [];
					console.log(criaHash.criaHash());
					$scope.operadoras = [
						{nome:"Oi", id: "01"},
						{nome:"Tim", id: "02"},
						{nome:"Claro", id: "03"},
						{nome:"Vivo", id: "04"},
						{nome:"Nextel", id: "05"}
					];
					var carregaContatos = function(){
							
							$.ajax(
								{url: "http://localhost:9090",
								method: "POST",
								// contentType: "application/json",
								accept: "*/*"
								
							}).done(function(data, status){
									console.log(data);
									$scope.contatos = JSON.parse(data);
									$scope.$apply();
							});
					};

					carregaContatos();

					$scope.addContato = function(contato){
							
							$.ajax(
								{url: 'http://localhost:9090/add',
								method: "POST",
								data : JSON.stringify(contato)
								}).done(function(data, status){
									// $scope.contatos.push(angular.copy(contato));
									console.log(data);
									carregaContatos();
									delete $scope.contato;
									$scope.formContato.$setPristine();
									
								}).fail(function(data, status){
										console.log('Status: ' + status);
										console.log('Data: ');
										console.log(data);
								});
					};
					$scope.removeContato = function(contato){
							// ok = confirm("Realmente Remover??");
							// if(ok){
							// 	$scope.contatos = contatos.filter(function(item){
							// 			if(item.selecionado){

							// 			}else{
							// 				return item;
							// 			}
							// 	}); 
								
							// }else{
							// 	$scope.contatos = contatos.map(function(item){
								
							// 		delete item.selecionado;
							// 		return item;na
								
							// 	});
							// }

							navigator.notification.confirm(
							    'You are the winner!',  // message
							    function(buttonIndex){
										if(buttonIndex==1){
											console.log('Yes OK');
											$.ajax({
												url: 'http://localhost:9090/remove',
												method: "POST",
												data : JSON.stringify(contato)
											}).done(function(data, status){
													carregaContatos();
											});

											
										}else{
												console.log('Not OK');
												$scope.contatos = $scope.contatos.map(function(item){
											
												console.log('Item Delete..');
												delete item.selecionado;
												return item;
											
											});
										}
										$scope.$apply();
							    },
							    'Game Over',            // title
							    ['OK', 'Exit']                  // buttonName
							);
							
							function onConfirm(buttonIndex) {
							    // ok = confirm("Realmente Remover??");
								if(buttonIndex==1){
									console.log('Yes OK');
									$scope.contatos = contatos.filter(function(item){
											if(item.selecionado){

											}else{
												return item;
											}
									}); 
									
									
								}else{
										console.log('Not OK');
										$scope.contatos = contatos.map(function(item){
									
										console.log('Item Delete..');
										delete item.selecionado;
										return item;
									
									});
								}
								$scope.$apply();
							}

							


							
					};
			});

			document.addEventListener("deviceready", onDeviceReady, false);
			function onDeviceReady() {
			    console.log(navigator.notification);
			}
		</script>
		
</head>
<body ng-controller='angCtrl'>
	<div class='container'>
		<h2>Hello Index In File</h2>
		<hr />
		<div class="col-md-6">
			<form name='formContato'>
				<input id='nome' ui-util='nome' type="text"  class="form-control" required name='nome' ng-model="contato.nome" placeholder="Nome"/>
				<input type="text" ui-util='telefone' class="form-control" ng-required='true' ng-pattern='/^\d{4,5}-\d{4}$/' name='telefone' ng-model="contato.telefone" placeholder="Telefone" />
				<input type="text" ui-util='cpf' class="form-control" ng-required='true' ng-pattern='/^\d{3}\.\d{3}\.\d{3}-\d{2}$/' name='cpf' ng-model="contato.cpf" placeholder="Cpf" />
				<button class="btn btn-primary btn-block" ng-disabled='formContato.$invalid' ng-click="addContato(contato)">Add Contato</button>
			</form>
			

			<div class="alert alert-danger" ng-show='formContato.nome.$error.required && formContato.nome.$dirty'>
					Digite o <strong>Nome</strong>
			</div>

			<div class="alert alert-danger" ng-show='formContato.telefone.$error.required && formContato.telefone.$dirty'>
					Digite o <strong>Telefone</strong>
			</div>
			<div class="alert alert-danger" ng-show='formContato.telefone.$error.pattern'>
					Padrão do <strong>Telefone</strong> incorreto. (Ex: 1234-5678, 12345-6789)
			</div>
			<div class="alert alert-danger" ng-show='formContato.cpf.$error.required && formContato.cpf.$dirty'>
					Digite o <strong>Cpf</strong>
			</div>
			<div class="alert alert-danger" ng-show='formContato.cpf.$error.pattern'>
					Padrão do <strong>Cpf</strong> incorreto. (Ex: 123.456.789-10)
			</div>
			<span class='badge'>{{contato}}</span>
			
		</div>
		<div class="col-md-6">
			
			<table class="table" ng-show="contatos.length > 0">
					<thead>
						<tr>	
							<td>#</td>
							<td>Nome</td>
							<td>Telefone</td>
							<td>Cpf</td>
						</tr>
					</thead>
					<tbody>
						<tr ng-repeat="item in contatos">
							<td><a href="" ng-click="item.selecionado = 'true'; removeContato(item)"><span class='glyphicon glyphicon-remove'></span></a></td>
							<td>{{item.pessoa_nome}}</td>
							<td>{{item.pessoa_telefone}}</td>
							<td>{{item.pessoa_cpf}}</td>
						</tr>
					</tbody>
			</table>
			<p>{{contatos}}</p>

		</div>
	</div>
	<div class='container'>
		<h2 ng-bind='msg'></h2>
		<button class='btn btn-primary btn-block' ng-click='carregaContatos()'>Carrega Contato</button>

		

	</div>
</body>
</html>